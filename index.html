<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eywallah Sim - Gerçek Hayat Simülasyonu</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2196F3;
      --background-dark: #1a1a1a;
      --text-light: #f0f0f0;
      --card-bg: #2a2a2a;
      --border-color: #444;
      --hover-bg: #3a3a3a;
      --danger-color: #f44336;
    }
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--background-dark);
      color: var(--text-light);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden; /* Prevent scroll on main body */
    }

    /* Global UI Elements */
    .container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      display: flex;
      justify-content: space-between;
      gap: 20px;
      padding: 20px;
      box-sizing: border-box;
    }
    .panel {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
    }
    h2, h3 {
      color: var(--primary-color);
      margin-top: 0;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    button {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease, transform 0.1s ease;
      width: 100%;
      margin-top: 10px;
    }
    button:hover {
      background-color: #1a7bbd; /* Darker secondary */
      transform: translateY(-1px);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      background-color: #666;
      cursor: not-allowed;
    }
    input[type="email"],
    input[type="password"],
    input[type="text"] {
      width: calc(100% - 20px);
      padding: 12px 10px;
      margin: 8px 0;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: #333;
      color: var(--text-light);
      font-size: 1rem;
    }
    label {
      display: block;
      margin-top: 10px;
      font-size: 0.9em;
      color: var(--text-light);
    }

    /* Specific Layout */
    #auth-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--background-dark);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      gap: 20px;
    }
    .auth-form {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      width: 350px;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    .auth-form h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    #auth-toggle-link {
      color: var(--secondary-color);
      cursor: pointer;
      font-size: 0.9em;
      margin-top: 15px;
      display: block;
    }
    #auth-error {
      color: var(--danger-color);
      margin-top: 10px;
      font-size: 0.9em;
    }

    /* Main Game UI */
    #game-container {
      display: none; /* Hidden by default until authenticated */
      width: 100%;
      height: 100%;
      position: relative;
    }
    #hud {
      position: sticky; /* Make HUD stay at top */
      top: 0;
      width: calc(100% - 40px); /* Adjust for padding */
      display: flex;
      justify-content: space-around;
      background: var(--background-dark); /* Ensure it covers content when sticky */
      padding: 10px 20px;
      border-bottom: 1px solid var(--border-color);
      z-index: 50;
      font-size: 1.1em;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    #hud p {
      margin: 0 15px;
      padding: 5px 10px;
      border-radius: 5px;
      background: #333;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #hud p strong {
      color: var(--primary-color);
      font-weight: bold;
    }

    .main-content {
      display: flex;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
      gap: 20px;
      justify-content: center;
      padding-top: 20px; /* Space for sticky HUD */
    }

    #cityMenu {
      flex: 1; /* Take available space */
      min-width: 280px; /* Minimum width */
      max-width: 350px;
      position: relative;
    }
    #cityMenu button {
      margin-bottom: 8px;
    }

    #eventBox {
      position: fixed; /* Fixed position for events */
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 25px;
      border-radius: 15px;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      min-width: 350px;
      max-width: 90%;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
      border: 1px solid var(--primary-color);
      animation: fadeIn 0.3s ease-out;
    }
    #eventBox p {
      margin-bottom: 20px;
      font-size: 1.15rem;
      text-align: center;
      line-height: 1.5;
    }
    #eventBox div {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }
    #eventBox button {
      flex: 1;
      min-width: 120px;
      max-width: 200px;
      margin: 0;
    }

    #phone {
      flex: 1;
      min-width: 280px;
      max-width: 350px;
      display: flex;
      flex-direction: column;
      height: 600px; /* Fixed height for phone */
      position: sticky;
      top: 100px; /* Position below HUD */
    }
    #phone .panel-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Manage internal scrolling */
    }
    #apps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 10px;
    }
    #apps button {
      width: auto; /* Let grid handle width */
      padding: 10px;
      margin: 0;
    }
    #appContent {
      flex: 1;
      overflow-y: auto; /* Scroll for app content */
      padding-right: 5px; /* For scrollbar */
      font-size: 0.95em;
      line-height: 1.4;
    }
    #appContent p {
      margin-bottom: 10px;
    }

    #game-info {
      flex: 2; /* Take more space */
      min-width: 300px;
      max-width: 600px;
      height: 600px; /* Fixed height for consistency */
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 100px;
    }
    #game-messages {
      flex: 1;
      overflow-y: auto;
      margin-top: 10px;
      border-top: 1px solid var(--border-color);
      padding-top: 10px;
    }
    #game-messages p {
      margin-bottom: 5px;
      font-size: 0.9em;
      color: #bbb;
    }
    .message-info { color: #888; }
    .message-success { color: var(--primary-color); }
    .message-warning { color: orange; }
    .message-error { color: var(--danger-color); }

    #next-day-btn {
      margin-top: 20px;
      background-color: var(--primary-color);
    }
    #next-day-btn:hover {
      background-color: #388e3c; /* Darker primary */
    }
    #logout-btn {
      margin-top: 20px;
      background-color: #666;
    }
    #logout-btn:hover {
      background-color: #555;
    }

    /* Mini Game */
    #miniGame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-light);
      z-index: 2000;
      animation: fadeIn 0.3s ease-out;
    }
    #miniGame h2 {
      font-size: 2em;
      margin-bottom: 30px;
      color: var(--secondary-color);
    }
    #miniGame button {
      width: 250px;
      margin: 10px;
      padding: 15px;
    }
    #miniGame button.success { background-color: var(--primary-color); }
    #miniGame button.fail { background-color: var(--danger-color); }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        padding: 10px;
        align-items: center;
      }
      #hud {
        flex-wrap: wrap;
        justify-content: center;
        padding: 10px 0;
        top: 0; /* Keep HUD at the very top */
      }
      #hud p {
        margin: 5px 10px;
        font-size: 0.95em;
      }
      .main-content {
        padding-top: 10px;
      }
      #cityMenu, #phone, #game-info {
        width: 95%;
        max-width: 95%;
        position: static; /* Remove sticky on small screens */
        height: auto; /* Let content define height */
      }
      #eventBox {
        min-width: unset;
        width: 95%;
      }
      #eventBox div {
        flex-direction: column;
        gap: 10px;
      }
      #eventBox button {
        width: 100%;
      }
    }
  </style>

  <!-- Firebase SDKs - Kendi projenin ayarlarını BURAYA EKLEMELİSİN -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script>
    // KENDİ FIREBASE YAPILANDIRMA BİLGİLERİNİ BURAYA EKLE!
    // Firebase Console > Project settings > Your apps kısmından bulabilirsin.
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Firebase'i başlat
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let gameData = {
      money: 500,
      age: 18,
      stress: 20,
      happiness: 50, /* Yeni Stat */
      health: 80,    /* Yeni Stat */
      education: 0,  /* Yeni Stat */
      job: null,
      married: false,
      day: 1,        /* Yeni Stat */
      inventory: [], /* Yeni Stat */
      messages: []   /* Yeni Stat */
    };
    let currentEvent = null;
    let authMode = 'login'; // 'login' or 'register'

    // --- UTILITY FUNCTIONS ---
    function logMessage(text, type = 'info') {
      const messagesDiv = document.getElementById('game-messages');
      const p = document.createElement('p');
      p.className = `message-${type}`;
      p.innerText = `[Gün ${gameData.day}] ${text}`;
      messagesDiv.prepend(p); // Add to top
      if (messagesDiv.children.length > 50) { // Keep message count reasonable
        messagesDiv.removeChild(messagesDiv.lastChild);
      }
    }

    function updateHUD() {
      document.getElementById("money").innerText = gameData.money.toLocaleString('tr-TR');
      document.getElementById("age").innerText = gameData.age;
      document.getElementById("stress").innerText = gameData.stress;
      document.getElementById("happiness").innerText = gameData.happiness;
      document.getElementById("health").innerText = gameData.health;
      document.getElementById("day").innerText = gameData.day;

      // Renklendirme ile durumu daha görünür yap
      document.getElementById("stress").style.color = gameData.stress > 70 ? varToString('--danger-color') : varToString('--text-light');
      document.getElementById("happiness").style.color = gameData.happiness < 30 ? varToString('--danger-color') : varToString('--text-light');
      document.getElementById("health").style.color = gameData.health < 40 ? varToString('--danger-color') : varToString('--text-light');
    }

    function varToString(variable) {
        // Simple way to get CSS variable value for JS conditional styling
        return getComputedStyle(document.documentElement).getPropertyValue(variable);
    }

    // --- FIREBASE AUTHENTICATION ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        logMessage(`Hoş Geldin, ${currentUser.email}!`, 'info');
        await loadGameData(user.uid);
      } else {
        currentUser = null;
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('auth-screen').style.display = 'flex';
        logMessage('Giriş yapın veya kaydolun.', 'info');
      }
      updateHUD();
    });

    async function handleAuthSubmit(event) {
      event.preventDefault();
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      const authError = document.getElementById('auth-error');
      authError.innerText = '';

      try {
        if (authMode === 'register') {
          await auth.createUserWithEmailAndPassword(email, password);
          logMessage('Başarıyla kaydolundu ve giriş yapıldı!', 'success');
        } else { // login
          await auth.signInWithEmailAndPassword(email, password);
          logMessage('Başarıyla giriş yapıldı!', 'success');
        }
      } catch (error) {
        console.error("Auth error:", error);
        authError.innerText = error.message;
      }
    }

    function toggleAuthMode() {
      authMode = authMode === 'login' ? 'register' : 'login';
      document.getElementById('auth-submit-btn').innerText = authMode === 'login' ? 'Giriş Yap' : 'Kaydol';
      document.getElementById('auth-toggle-link').innerText = authMode === 'login' ? 'Hesabınız yok mu? Kaydolun' : 'Zaten hesabınız var mı? Giriş yapın';
      document.getElementById('auth-error').innerText = ''; // Clear errors on toggle
    }

    function signOutUser() {
      auth.signOut().then(() => {
        logMessage('Çıkış yapıldı.', 'info');
        // Reset game data when signing out
        gameData = {
          money: 500, age: 18, stress: 20, happiness: 50, health: 80, education: 0,
          job: null, married: false, day: 1, inventory: [], messages: []
        };
        updateHUD();
      }).catch((error) => {
        console.error("Sign out error:", error);
      });
    }

    // --- FIRESTORE GAME DATA ---
    async function saveGameData() {
      if (currentUser) {
        try {
          // Firestore'a kaydetmeden önce message array'ini temizleyebiliriz,
          // veya son N mesajı kaydedebiliriz.
          // Şimdilik, sadece önemli gameData'yı kaydedelim.
          const dataToSave = { ...gameData };
          delete dataToSave.messages; // Messages are temporary log, not saved.

          await db.collection('users').doc(currentUser.uid).set(dataToSave);
          logMessage('Oyun kaydedildi!', 'info');
        } catch (error) {
          console.error("Error saving game data:", error);
          logMessage('Oyun kaydedilirken bir hata oluştu.', 'error');
        }
      }
    }

    async function loadGameData(uid) {
      try {
        const doc = await db.collection('users').doc(uid).get();
        if (doc.exists) {
          gameData = { ...gameData, ...doc.data() }; // Overwrite with saved data
          logMessage('Kayıtlı oyun yüklendi.', 'success');
        } else {
          logMessage('Yeni oyun başlatıldı.', 'info');
        }
      } catch (error) {
        console.error("Error loading game data:", error);
        logMessage('Oyun yüklenirken bir hata oluştu.', 'error');
      }
      updateHUD();
    }

    // --- GAME MECHANICS ---
    function showEvent(text, options) {
      currentEvent = { text, options };
      document.getElementById("eventText").innerText = text;
      const eventOptionsDiv = document.querySelector("#eventBox div");
      eventOptionsDiv.innerHTML = ''; // Clear previous options

      options.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.innerText = option.text;
        btn.onclick = () => chooseOption(index);
        eventOptionsDiv.appendChild(btn);
      });

      document.getElementById("eventBox").style.display = "flex";
      logMessage(`Yeni olay: "${text.substring(0, 30)}..."`, 'info');
    }

    function chooseOption(optionIndex) {
      if (!currentEvent || !currentEvent.options[optionIndex]) return;

      const chosenOption = currentEvent.options[optionIndex];
      chosenOption.action(); // Execute the action linked to the option

      document.getElementById("eventBox").style.display = "none";
      updateHUD();
      currentEvent = null;
      saveGameData(); // Save after each significant action
    }

    // Şehir ziyaret
    function visit(place) {
      let eventText = "";
      let options = [];

      switch (place) {
        case 'banka':
          eventText = "Banka müdürü sizi karşıladı. 'Nasıl yardımcı olabiliriz?'";
          options = [
            { text: "Mevduat Hesabı Aç (Para kilitlenir, faiz gelir)", action: () => {
                logMessage("Mevduat hesabı açtınız.", 'info');
                // Daha kompleks faiz mekaniği eklenebilir
              }},
            { text: "Kredi Çek (500₺, %10 faiz)", action: () => {
                gameData.money += 500;
                gameData.stress += 10;
                logMessage("500₺ kredi çektiniz. Ay sonu ödeme zamanı!", 'warning');
              }},
            { text: "Harcamalarını İncele", action: () => { logMessage("Harcama geçmişiniz şimdilik boş.", 'info'); }}
          ];
          break;
        case 'is':
          eventText = "İş bulma kurumu. 'Hangi alanda çalışmak istersiniz?'";
          options = [
            { text: "Garson (Maaş: 150₺/gün, Stres +5)", action: () => {
                gameData.job = "Garson";
                logMessage("Garson olarak işe başladınız!", 'success');
              }},
            { text: "Taksici (Maaş: 200₺/gün, Stres +7)", action: () => {
                gameData.job = "Taksici";
                logMessage("Taksici olarak işe başladınız!", 'success');
              }},
            { text: "Yazılımcı (Maaş: 400₺/gün, Eğitim gerektirir)", action: () => {
                if (gameData.education >= 50) {
                  gameData.job = "Yazılımcı";
                  logMessage("Yazılımcı olarak işe başladınız!", 'success');
                } else {
                  logMessage("Yeterli eğitim seviyeniz yok (Min. 50 eğitim puanı gerekli).", 'error');
                }
              }}
          ];
          break;
        case 'galeri':
          eventText = "Araba galerisi. 'Sizin için hangi model uygun?'";
          options = [
            { text: "Ucuz Araba (500₺, Stres -5)", action: () => {
                if (gameData.money >= 500) { gameData.money -= 500; gameData.stress -= 5; logMessage("Ucuz bir araba aldınız.", 'success'); }
                else { logMessage("Yeterli paranız yok.", 'error'); }
              }},
            { text: "Orta Sınıf Araba (5000₺, Stres -10)", action: () => {
                if (gameData.money >= 5000) { gameData.money -= 5000; gameData.stress -= 10; logMessage("Orta sınıf bir araba aldınız.", 'success'); }
                else { logMessage("Yeterli paranız yok.", 'error'); }
              }}
          ];
          break;
        case 'okul':
          eventText = "Okulda ders çalışma zamanı. Bilgini artırabilirsin.";
          options = [
            { text: "Ders Çalış (+10 Eğitim, Stres +5, 50₺)", action: () => {
                if (gameData.money >= 50) { gameData.money -= 50; gameData.education += 10; gameData.stress += 5; logMessage("Ders çalıştınız ve eğitiminizi artırdınız.", 'success'); }
                else { logMessage("Ders materyalleri için yeterli paranız yok.", 'error'); }
              }},
            { text: "Sosyal Faaliyetlere Katıl (+5 Mutluluk, Stres -5, 30₺)", action: () => {
                if (gameData.money >= 30) { gameData.money -= 30; gameData.happiness += 5; gameData.stress -= 5; logMessage("Sosyal faaliyetlere katıldınız.", 'success'); }
                else { logMessage("Sosyal faaliyetler için yeterli paranız yok.", 'error'); }
              }}
          ];
          break;
        case 'evlilik':
          eventText = gameData.married ? "Eşinle ilişkin nasıl gidiyor?" : "Evlilik dairesindesin. Hayat arkadaşını bulmak ister misin?";
          options = gameData.married ? [
            { text: "Eşine Hediye Al (100₺, Mutluluk +10)", action: () => {
                if (gameData.money >= 100) { gameData.money -= 100; gameData.happiness += 10; logMessage("Eşine hediye aldın.", 'success'); }
                else { logMessage("Hediye almak için yeterli paran yok.", 'error'); }
              }},
            { text: "Boşan (Stres +50, Mutluluk -20)", action: () => {
                gameData.married = false; gameData.stress += 50; gameData.happiness -= 20; logMessage("Boşandınız. Yeni bir sayfa açılıyor.", 'warning');
              }}
          ] : [
            { text: "Evlen (1000₺, Mutluluk +20)", action: () => {
                if (gameData.money >= 1000) { gameData.married = true; gameData.money -= 1000; gameData.happiness += 20; logMessage("Evlendiniz! Mutlu bir başlangıç.", 'success'); }
                else { logMessage("Düğün için yeterli paranız yok.", 'error'); }
              }},
            { text: "Bekar Kal (Stres -5)", action: () => { gameData.stress -= 5; logMessage("Şimdilik bekar kalmaya karar verdiniz.", 'info'); }}
          ];
          break;
        case 'market':
          eventText = "Market reyonları çeşit çeşit ürünlerle dolu. Neye ihtiyacın var?";
          options = [
            { text: "Yiyecek Al (50₺, Sağlık +5, Stres -10)", action: () => {
                if (gameData.money >= 50) { gameData.money -= 50; gameData.health += 5; gameData.stress -= 10; logMessage("Sağlıklı yiyecekler aldınız.", 'success'); }
                else { logMessage("Yiyecek için yeterli paranız yok.", 'error'); }
              }},
            { text: "Atıştırmalık Al (20₺, Sağlık -2, Mutluluk +5)", action: () => {
                if (gameData.money >= 20) { gameData.money -= 20; gameData.health -= 2; gameData.happiness += 5; logMessage("Atıştırmalık aldınız. Kısa süreli mutluluk.", 'success'); }
                else { logMessage("Atıştırmalık için yeterli paranız yok.", 'error'); }
              }}
          ];
          break;
        case 'hastane':
          eventText = "Hastane. Sağlığın için önemli bir yer.";
          options = [
            { text: "Muayene Ol (100₺, Sağlık +10, Stres -15)", action: () => {
                if (gameData.money >= 100) { gameData.money -= 100; gameData.health += 10; gameData.stress -= 15; logMessage("Muayene oldunuz. Daha iyi hissediyorsunuz.", 'success'); }
                else { logMessage("Muayene için yeterli paranız yok.", 'error'); }
              }},
            { text: "Tedavi Gör (250₺, Sağlık +30, Stres -20)", action: () => {
                if (gameData.money >= 250) { gameData.money -= 250; gameData.health += 30; gameData.stress -= 20; logMessage("Tedavi gördünüz. Sağlığınız önemli ölçüde iyileşti.", 'success'); }
                else { logMessage("Tedavi için yeterli paranız yok.", 'error'); }
              }}
          ];
          break;
        default:
          eventText = "Bu yerle ilgili bir sorun var.";
          options = [{ text: "Tamam", action: () => {} }];
          break;
      }
      showEvent(eventText, options);
    }

    // Telefon uygulamaları
    function openApp(app) {
      const appContent = document.getElementById("appContent");
      appContent.innerHTML = ''; // Clear previous app content

      switch (app) {
        case 'borsa':
          let tl_usd = (20 + Math.random() * 5).toFixed(2);
          let bist = (5000 + Math.random() * 500).toFixed(0);
          appContent.innerHTML = `<h3>📊 Borsa</h3><p>💱 Dolar/TL: <strong>${tl_usd}</strong></p><p>📈 BIST100: <strong>${bist}</strong></p><p class="message-info">Geliştirilecek: Hisse alım/satım.</p>`;
          logMessage("Borsa uygulamasını açtınız.", 'info');
          break;
        case 'gorev':
          appContent.innerHTML = `<h3>📌 Görevler</h3>`;
          if (gameData.job) {
            appContent.innerHTML += `<p>Mevcut işin: <strong>${gameData.job}</strong></p><button onclick="startMiniGame()">Görevi Oyna</button>`;
            logMessage(`İş görevlerinizi kontrol ettiniz.`, 'info');
          } else {
            appContent.innerHTML += "<p>Henüz bir işiniz yok. İş bulma kurumunu ziyaret edin.</p>";
            logMessage("İşiniz olmadığı için görev bulamadınız.", 'warning');
          }
          break;
        case 'mesaj':
          appContent.innerHTML = `<h3>💬 Mesajlar</h3>`;
          if (gameData.messages.length > 0) {
            gameData.messages.forEach(msg => {
              appContent.innerHTML += `<p><strong>${msg.sender}:</strong> ${msg.text}</p>`;
            });
          } else {
            appContent.innerHTML += "<p>Hiç yeni mesajınız yok.</p>";
          }
          logMessage("Mesajlarınızı kontrol ettiniz.", 'info');
          break;
        default:
          appContent.innerHTML = `<h3>Uygulama Bulunamadı</h3><p>Bu uygulama henüz geliştirilmedi.</p>`;
          logMessage("Bilinmeyen bir uygulama açmaya çalıştınız.", 'error');
          break;
      }
    }

    // Görev / mini oyun
    function startMiniGame() {
      document.getElementById("miniGame").style.display = "flex";
      document.getElementById("miniGameText").innerText = `Görev: ${gameData.job} olarak çalışıyorsun. Başarılı olmak için ne yapmalısın?`;
      logMessage(`Mini oyuna başladınız: ${gameData.job} görevi.`, 'info');
    }

    function finishMiniGame(success) {
      document.getElementById("miniGame").style.display = "none";
      let reward = 0;
      let stressChange = 0;
      let happinessChange = 0;

      if (success) {
        reward = gameData.job === "Garson" ? 150 : (gameData.job === "Taksici" ? 200 : (gameData.job === "Yazılımcı" ? 400 : 100));
        stressChange = -5;
        happinessChange = 10;
        logMessage(`Görevi başarıyla tamamladınız! ${reward}₺ kazandınız.`, 'success');
      } else {
        reward = -50; // Ceza
        stressChange = 10;
        happinessChange = -5;
        logMessage(`Görevi başarısız oldunuz. 50₺ kaybettiniz.`, 'error');
      }

      gameData.money += reward;
      gameData.stress = Math.max(0, Math.min(100, gameData.stress + stressChange));
      gameData.happiness = Math.max(0, Math.min(100, gameData.happiness + happinessChange));
      updateHUD();
      saveGameData();
    }

    // --- DAY MECHANIC ---
    function nextDay() {
      gameData.day++;
      gameData.age = 18 + Math.floor(gameData.day / 365); // Her 365 günde 1 yaş
      
      // Günlük giderler ve stres artışı
      gameData.money -= 50; // Temel yaşam giderleri
      gameData.stress += 5; // Günlük yaşam stresi
      gameData.happiness -= 2; // Mutluluk azalır

      // Sağlık ve mutluluk dengesi
      if (gameData.stress > 80) gameData.health -= 5;
      if (gameData.happiness < 20) gameData.stress += 5;
      if (gameData.health < 30) gameData.happiness -= 5;

      // İş varsa maaş
      if (gameData.job) {
        let dailySalary = 0;
        if (gameData.job === "Garson") dailySalary = 150;
        else if (gameData.job === "Taksici") dailySalary = 200;
        else if (gameData.job === "Yazılımcı") dailySalary = 400; // Requires high education
        gameData.money += dailySalary;
        logMessage(`${gameData.job} işinden ${dailySalary}₺ kazandınız.`, 'success');
      } else {
        logMessage("İşiniz olmadığı için bugün maaş alamadınız.", 'warning');
      }

      // Rastgele olaylar
      triggerRandomEvent();

      // Değerleri sınırlar içinde tut
      gameData.money = Math.max(0, gameData.money);
      gameData.stress = Math.max(0, Math.min(100, gameData.stress));
      gameData.happiness = Math.max(0, Math.min(100, gameData.happiness));
      gameData.health = Math.max(0, Math.min(100, gameData.health));

      if (gameData.health <= 0 || gameData.stress >= 100) {
        logMessage("Oyun bitti! Çok yorgun veya sağlıksızsınız.", 'error');
        // Oyun bitiş ekranı gösterilebilir
        alert("Oyun bitti! Yaşam mücadeleniz sona erdi.");
        signOutUser(); // Oyunu bitirip çıkış yap
        return;
      }

      updateHUD();
      saveGameData();
    }

    // --- DIALOG / EVENT SYSTEM ---
    const dialogs = [
      {
        type: "random",
        condition: (gd) => gd.money < 200,
        text: "Cebinizde fazla para kalmamış. Bir şeyler yapmalısınız.",
        options: [
          { text: "İş arayışına gir", action: () => visit('is') },
          { text: "Riskli bir yatırım yap", action: () => {
              const outcome = Math.random();
              if (outcome < 0.3) { gameData.money += 300; logMessage("Riskli yatırımınız kazanç getirdi!", 'success'); }
              else { gameData.money -= 100; gameData.stress += 10; logMessage("Yatırımınız hüsranla sonuçlandı.", 'error'); }
            }}
        ]
      },
      {
        type: "random",
        condition: (gd) => gd.stress > 60 && gd.happiness < 40,
        text: "Kendinizi bunalmış ve mutsuz hissediyorsunuz.",
        options: [
          { text: "Dinlen ve eğlen (100₺, Stres -20, Mutluluk +15)", action: () => {
              if (gameData.money >= 100) { gameData.money -= 100; gameData.stress -= 20; gameData.happiness += 15; logMessage("Biraz dinlendiniz ve kendinize geldiniz.", 'success'); }
              else { logMessage("Dinlenmek için yeterli paranız yok.", 'error'); }
            }},
          { text: "Çalışmaya devam et (Stres +10)", action: () => { gameData.stress += 10; logMessage("Dinlenmek yerine çalışmaya devam ettiniz.", 'warning'); }}
        ]
      },
      {
        type: "random",
        condition: (gd) => gd.education < 30 && gd.age > 22 && !gd.job,
        text: "Eğitim seviyeniz düşük ve işsizsiniz. Geleceğiniz için endişeleniyorsunuz.",
        options: [
          { text: "Okula git (Daha fazla eğitim)", action: () => visit('okul') },
          { text: "Vasat bir iş bul", action: () => visit('is') }
        ]
      },
      {
        type: "random",
        condition: (gd) => gd.married && Math.random() < 0.2, // Married + 20% chance
        text: "Eşiniz sizinle konuşmak istiyor. Bir tartışma konusu var gibi görünüyor.",
        options: [
          { text: "Dinle ve uzlaş (Mutluluk +5, Stres -5)", action: () => { gameData.happiness += 5; gameData.stress -= 5; logMessage("Eşinizle uzlaştınız.", 'success'); }},
          { text: "Tartış (Mutluluk -10, Stres +10)", action: () => { gameData.happiness -= 10; gameData.stress += 10; logMessage("Eşinizle tartıştınız.", 'error'); }}
        ]
      },
      // Daha fazla diyalog buraya eklenebilir.
      // Toplam 200 diyalog için bu yapıyı kopyalayıp genişletebilirsin.
      // Her diyalog için 'type', 'condition', 'text' ve 'options' alanlarını doldurmalısın.
    ];

    function triggerRandomEvent() {
      // Sadece belirli bir olasılıkla veya koşul sağlandığında olay tetikle
      if (Math.random() < 0.3) { // %30 ihtimalle rastgele olay
        const availableDialogs = dialogs.filter(d => d.type === "random" && d.condition(gameData));
        if (availableDialogs.length > 0) {
          const randomIndex = Math.floor(Math.random() * availableDialogs.length);
          const randomDialog = availableDialogs[randomIndex];
          showEvent(randomDialog.text, randomDialog.options);
        }
      }
    }

    // Initial load for HUD
    // updateHUD(); // This is called by onAuthStateChanged now

    // Bağlantıları ayarla
    document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit);
    document.getElementById('auth-toggle-link').addEventListener('click', toggleAuthMode);
    document.getElementById('logout-btn').addEventListener('click', signOutUser);
    document.getElementById('next-day-btn').addEventListener('click', nextDay);
  </script>
</body>
</html>
